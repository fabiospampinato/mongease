/* IMPORT */
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var _ = require("lodash");
var mongoose = require("mongoose");
/* MONGEASE */
var Mongease = {
    /* VARIABLES */
    _parsed: {},
    _plugins: [],
    /* GET */
    get: function (name, sub) {
        if (name)
            return _.get(Mongease._parsed, sub ? [name, sub] : name);
        if (sub)
            return _.map(Mongease._parsed, sub);
        return Mongease._parsed;
    },
    getConfigs: function () {
        return Mongease.get(undefined, 'config');
    },
    getConfig: function (name) {
        var config = Mongease.get(name, 'config');
        if (!config)
            throw new Error('[mongease] Configuration not found');
        return config;
    },
    getSchemas: function () {
        return Mongease.get(undefined, 'schema');
    },
    getSchema: function (name) {
        var Schema = Mongease.get(name, 'schema');
        if (!Schema)
            throw new Error('[mongease] Schema not found');
        return Schema;
    },
    getModels: function () {
        return Mongease.get(undefined, 'model');
    },
    getModel: function (name) {
        var model = Mongease.get(name, 'model');
        if (!_.isFunction(model))
            throw new Error('[mongease] Model not found');
        return model;
    },
    /* SET */
    set: function (name, sub, value) {
        if (!sub)
            return Mongease._parsed = name;
        if (_.isUndefined(value)) {
            value = sub;
            sub = undefined;
        }
        _.set(Mongease._parsed, _.isUndefined(sub) ? name : [name, sub], value);
        return value;
    },
    setConfig: function (name, config) {
        return Mongease.set(name, 'config', config);
    },
    setSchema: function (name, Schema) {
        return Mongease.set(name, 'schema', Schema);
    },
    setModel: function (name, model) {
        return Mongease.set(name, 'model', model);
    },
    /* RESET */
    reset: function () {
        Mongease.set({});
        return Mongease;
    },
    /* PLUGIN */
    plugin: function (plugin) {
        Mongease._plugins = Mongease._plugins.concat(_.castArray(plugin));
        return Mongease;
    },
    /* MAKE */
    make: function (name, config) {
        if (!config.hasOwnProperty('schema'))
            throw new Error('[mongease] The configuration must provide a schema');
        for (var _i = 0, _a = Mongease.makers.order; _i < _a.length; _i++) {
            var maker = _a[_i];
            if (!config.hasOwnProperty(maker))
                continue;
            Mongease.makers[maker](name, config[maker], config);
        }
        var schema = Mongease.getSchema(name), model = Mongease.makers.model(name);
        for (var _b = 0, _c = Mongease._plugins; _b < _c.length; _b++) {
            var plugin = _c[_b];
            plugin(name, config);
        }
        return { schema: schema, model: model };
    },
    makers: {
        order: ['schema', 'index', 'plugins', 'query', 'statics', 'methods', 'virtuals'],
        schema: function (name, schema, plain) {
            Mongease.setConfig(name, plain);
            var options = plain['options'], needsId = !schema.hasOwnProperty('_id') && (!options || options._id !== false);
            if (needsId)
                _.extend(schema, { _id: { type: mongoose.Schema.Types.ObjectId, default: function () { return new mongoose.Types.ObjectId(); } } });
            var Schema = new mongoose.Schema(schema, options);
            return Mongease.setSchema(name, Schema);
        },
        index: function (name, indexes) {
            var Schema = Mongease.getSchema(name);
            Schema.index(indexes);
            return Schema;
        },
        plugins: function (name, plugins) {
            var Schema = Mongease.getSchema(name);
            for (var _i = 0, plugins_1 = plugins; _i < plugins_1.length; _i++) {
                var plugin = plugins_1[_i];
                plugin = _.castArray(plugin);
                Schema.plugin(plugin[0], plugin[1]);
            }
            return Schema;
        },
        query: function (name, queries) {
            var Schema = Mongease.getSchema(name);
            _.extend(Schema['query'], queries);
            return Schema;
        },
        statics: function (name, statics) {
            var Schema = Mongease.getSchema(name);
            _.extend(Schema.statics, statics);
            return Schema;
        },
        methods: function (name, methods) {
            var Schema = Mongease.getSchema(name);
            _.extend(Schema.methods, methods);
            return Schema;
        },
        virtuals: function (name, virtuals) {
            var Schema = Mongease.getSchema(name);
            for (var virtual in virtuals) {
                if (!virtuals.hasOwnProperty(virtual))
                    continue;
                for (var _i = 0, _a = ['get', 'set']; _i < _a.length; _i++) {
                    var kind = _a[_i];
                    if (!virtuals[virtual].hasOwnProperty(kind))
                        continue;
                    Schema.virtual(virtual)[kind](virtuals[virtual]);
                }
            }
            return Schema;
        },
        model: function (name) {
            var Schema = Mongease.getSchema(name);
            var Model;
            if (!mongoose.model) {
                Model = function () { };
                Model['modelName'] = name;
                var config = Mongease.getConfig(name);
                _.extend(Model, config['statics']);
            }
            else {
                Model = mongoose.model(name, Schema);
            }
            return Mongease.setModel(name, Model);
        }
    }
};
/* EXPORT */
exports.default = Mongease;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsWUFBWTs7O0FBRVosMEJBQTRCO0FBQzVCLG1DQUFxQztBQUVyQyxjQUFjO0FBRWQsSUFBTSxRQUFRLEdBQUc7SUFFZixlQUFlO0lBRWYsT0FBTyxFQUFFLEVBQUU7SUFDWCxRQUFRLEVBQUUsRUFBZ0I7SUFFMUIsU0FBUztJQUVULEdBQUcsRUFBSCxVQUFNLElBQWEsRUFBRSxHQUFZO1FBRS9CLEVBQUUsQ0FBQyxDQUFFLElBQUssQ0FBQztZQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBRSxDQUFDO1FBRXhFLEVBQUUsQ0FBQyxDQUFFLEdBQUksQ0FBQztZQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFFLENBQUM7UUFFbEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7SUFFMUIsQ0FBQztJQUVELFVBQVUsRUFBVjtRQUVFLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFHLFNBQVMsRUFBRSxRQUFRLENBQUUsQ0FBQztJQUU5QyxDQUFDO0lBRUQsU0FBUyxFQUFULFVBQVksSUFBWTtRQUV0QixJQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFHLElBQUksRUFBRSxRQUFRLENBQUUsQ0FBQztRQUUvQyxFQUFFLENBQUMsQ0FBRSxDQUFDLE1BQU8sQ0FBQztZQUFDLE1BQU0sSUFBSSxLQUFLLENBQUcsb0NBQW9DLENBQUUsQ0FBQztRQUV4RSxNQUFNLENBQUMsTUFBTSxDQUFDO0lBRWhCLENBQUM7SUFFRCxVQUFVLEVBQVY7UUFFRSxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBRyxTQUFT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